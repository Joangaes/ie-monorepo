{
  "_comment": "AWS Elastic Beanstalk Dockerrun v2 - Multi-container Django + Next.js + Nginx setup",
  "_comment_secrets": "All placeholder values are substituted by GitHub Actions during deployment",
  "_comment_logging": "All containers use awslogs driver to send logs to CloudWatch AND maintain stdout/stderr for EB logs",
  "AWSEBDockerrunVersion": 2,
  "containerDefinitions": [
    {
      "name": "django",
      "image": "${ECR_REPOSITORY_URI}:${BACKEND_IMAGE_TAG}",
      "essential": false,
      "memory": 512,
      "portMappings": [
        { "containerPort": 8000, "protocol": "tcp" }
      ],
      "environment": [
        { "name": "DJANGO_SETTINGS_MODULE", "value": "ie_professor_management.settings" },
        { "name": "DEBUG", "value": "false" },
        { "name": "DJANGO_ALLOWED_HOSTS", "value": "${DJANGO_ALLOWED_HOSTS}" },
        { "name": "SECRET_KEY", "value": "${DJANGO_SECRET_KEY}" },
        { "name": "DB_NAME", "value": "${DB_NAME}" },
        { "name": "DB_USER", "value": "${DB_USER}" },
        { "name": "DB_PASSWORD", "value": "${DB_PASSWORD}" },
        { "name": "DB_HOST", "value": "${DB_HOST}" },
        { "name": "DB_PORT", "value": "${DB_PORT}" },
        { "name": "PYTHONUNBUFFERED", "value": "1" },
        { "name": "PYTHONDONTWRITEBYTECODE", "value": "1" }
      ],
      "command": [
        "gunicorn",
        "ie_professor_management.wsgi:application",
        "--bind", "0.0.0.0:8000",
        "--workers", "3",
        "--timeout", "120",
        "--access-logfile", "-",
        "--error-logfile", "-"
      ],
      "healthCheck": {
        "retries": 5,
        "command": ["CMD-SHELL", "curl -fsS http://localhost:8000/api/healthz/ || exit 1"],
        "timeout": 5,
        "interval": 15,
        "startPeriod": 60
      },
      "logConfiguration": {
        "logDriver": "json-file"
      }
    },
    {
      "name": "next",
      "image": "${ECR_REPOSITORY_URI}:${FRONTEND_IMAGE_TAG}",
      "essential": false,
      "memory": 256,
      "portMappings": [
        { "containerPort": 3000, "protocol": "tcp" }
      ],
      "environment": [
        { "name": "NODE_ENV", "value": "production" },
        { "name": "NEXT_TELEMETRY_DISABLED", "value": "1" },
        { "name": "NEXT_PUBLIC_API_URL", "value": "/api" },
        { "name": "PORT", "value": "3000" }
      ],
      "healthCheck": {
        "retries": 2,
        "command": [
          "CMD-SHELL",
          "node -e \"require('http').get('http://localhost:3000/', r => process.exit(r.statusCode < 400 ? 0 : 1)).on('error', () => process.exit(1))\""
        ],
        "timeout": 2,
        "interval": 5,
        "startPeriod": 15
      },
      "logConfiguration": {
        "logDriver": "json-file"
      }
    },
    {
      "name": "nginx",
      "image": "nginx:alpine",
      "essential": true,
      "memory": 128,
      "portMappings": [
        { "containerPort": 80, "hostPort": 80, "protocol": "tcp" }
      ],
      "mountPoints": [
        { "sourceVolume": "nginx-config", "containerPath": "/etc/nginx/conf.d" }
      ],
      "dependsOn": [
        { "containerName": "django", "condition": "HEALTHY" },
        { "containerName": "next", "condition": "START" }
      ],
      "logConfiguration": {
        "logDriver": "json-file"
      }
    }
  ],
  "volumes": [
    {
      "name": "nginx-config",
      "host": { "sourcePath": "/var/app/current/deploy" }
    }
  ]
}